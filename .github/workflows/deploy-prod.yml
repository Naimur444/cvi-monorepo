name: Deploy Admin Panel to Production

on:
  push:
    branches:
      - prod

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.PERSONAL_ACCESS_TOKEN }}

    - name: Deploy to Contabo Server
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.CONTABO_SSH_HOST }}
        username: ${{ secrets.CONTABO_SSH_USER }}
        password: ${{ secrets.CONTABO_SSH_PASS }}
        script: |
          set -e
          
          echo "ğŸš€ Starting deployment process..."
          
          # Define variables
          APP_NAME="cvi-admin"
          APP_DIR="/var/www/cloudvortexi_usr/data/www/sscviadmin.cloudvortexinnovation.com"
          REPO_URL="https://${{ secrets.PERSONAL_ACCESS_TOKEN }}@github.com/${{ github.repository }}.git"
          
          # Stop and delete existing PM2 process
          echo "â¹ï¸  Stopping PM2 process..."
          pm2 stop $APP_NAME || echo "PM2 process not running"
          pm2 delete $APP_NAME || echo "PM2 process not found"
          
          # Remove existing codebase
          echo "ğŸ—‘ï¸  Removing existing codebase..."
          rm -rf $APP_DIR
          
          # Create directory and clone new codebase
          echo "ğŸ“¥ Cloning new codebase..."
          mkdir -p $APP_DIR
          cd $APP_DIR
          git clone -b prod $REPO_URL temp_repo
          
          # Move admin panel files to root directory
          echo "ğŸ“ Moving files to root directory..."
          mv temp_repo/cloud-vortex-innovation-admin/* .
          mv temp_repo/cloud-vortex-innovation-admin/.* . 2>/dev/null || true
          rm -rf temp_repo
          
          # Clear npm cache to avoid any caching issues
          echo "ğŸ§¹ Clearing npm cache..."
          npm cache clean --force
          
          # Install dependencies
          echo "ğŸ“¦ Installing dependencies..."
          npm ci
          
          # Build the application
          echo "ğŸ”¨ Building application..."
          npm run build
          
          # Start with PM2
          echo "â–¶ï¸  Starting application with PM2..."
          pm2 start npm --name "$APP_NAME" -- start
          
          # Save PM2 configuration
          echo "ğŸ’¾ Saving PM2 configuration..."
          pm2 save
          
          # Show PM2 status
          echo "ğŸ“Š PM2 Status:"
          pm2 status
          
          echo "âœ… Deployment completed successfully!"